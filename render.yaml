services:
  - type: web
    name: bambu-lab-test
    env: python
    buildCommand: |
      set -e
      echo "üîß Installing Python dependencies..."
      pip install -r requirements.txt

      echo "üì• Downloading SuperSlicer (linux)..."
      wget -q https://github.com/supermerill/SuperSlicer/releases/download/2.7.61.1/SuperSlicer-2.7.61.1-linux.tar.xz

      echo "üì¶ Extracting SuperSlicer..."
      tar -xf SuperSlicer-2.7.61.1-linux.tar.xz

      echo "üìÅ Creating installation directory..."
      mkdir -p /opt/render/superslicer

      echo "üîç Locating superslicer_console in the extracted tree..."
      # prefer known locations, otherwise search
      if [ -f "SuperSlicer-2.7.61.1-linux/superslicer_console" ]; then
        SRC="SuperSlicer-2.7.61.1-linux/superslicer_console"
      elif [ -f "SuperSlicer-2.7.61.1-linux/bin/superslicer_console" ]; then
        SRC="SuperSlicer-2.7.61.1-linux/bin/superslicer_console"
      else
        SRC=$(find SuperSlicer-2.7.61.1-linux -type f -name "*superslicer*" -print -quit || true)
        # fallback: any executable found
        if [ -z "$SRC" ]; then
          SRC=$(find SuperSlicer-2.7.61.1-linux -type f -executable -print -quit || true)
        fi
      fi

      if [ -n "$SRC" ]; then
        echo "‚úÖ Found: $SRC"
        cp "$SRC" /opt/render/superslicer/superslicer_console
        chmod +x /opt/render/superslicer/superslicer_console
        echo "üîê Permissions set"
        echo "üß™ Verifying binary..."
        /opt/render/superslicer/superslicer_console --version || /opt/render/superslicer/superslicer_console --help || true
        ls -la /opt/render/superslicer/superslicer_console || true
      else
        echo "‚ö†Ô∏è  SuperSlicer binary not found in archive -> app will run in demo mode"
        echo "üìÅ Extracted contents:"
        ls -la SuperSlicer-2.7.61.1-linux || true
      fi

      # optional cleanup
      rm -f SuperSlicer-2.7.61.1-linux.tar.xz || true

    startCommand: gunicorn --bind 0.0.0.0:$PORT app:app --workers 2 --timeout 300 --preload

    envVars:
      - key: SUPERSLICER_PATH
        value: /opt/render/superslicer/superslicer_console
      - key: COST_PER_HOUR
        value: "3.0"
      - key: DEBUG
        value: "False"
      - key: SECRET_KEY
        value: your-production-secret-key-change-this
      - key: PORT
        value: "5000"
