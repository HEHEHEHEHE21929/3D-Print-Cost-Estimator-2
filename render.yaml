services:
  - type: web
    name: bambu-lab-test
    env: python
    buildCommand: |
      set -e
      
      echo "üîß Installing Python dependencies..."
      pip install -r requirements.txt
      
      echo "üì• Downloading SuperSlicer..."
      wget -q --show-progress https://github.com/supermerill/SuperSlicer/releases/download/2.7.61.1/SuperSlicer-2.7.61.1-linux.tar.xz
      
      echo "üì¶ Extracting SuperSlicer..."
      tar -xf SuperSlicer-2.7.61.1-linux.tar.xz
      
      echo "üìÅ Creating installation directory..."
      mkdir -p /opt/render/superslicer
      
      echo "üîç Looking for SuperSlicer executable..."
      FOUND=false
      
      # Check multiple possible locations in extracted files
      if [ -f "SuperSlicer-2.7.61.1-linux/superslicer_console" ]; then
        echo "‚úÖ Found superslicer_console in root directory"
        cp SuperSlicer-2.7.61.1-linux/superslicer_console /opt/render/superslicer/superslicer_console
        FOUND=true
      elif [ -f "SuperSlicer-2.7.61.1-linux/bin/superslicer_console" ]; then
        echo "‚úÖ Found superslicer_console in bin directory"
        cp SuperSlicer-2.7.61.1-linux/bin/superslicer_console /opt/render/superslicer/superslicer_console
        FOUND=true
      else
        echo "üîç Searching all extracted files..."
        find SuperSlicer-2.7.61.1-linux -name "*superslicer*" -type f
        
        # Try to find any superslicer executable
        SUPERSLICER_FILE=$(find SuperSlicer-2.7.61.1-linux -name "*superslicer*" -type f | head -1)
        if [ -n "$SUPERSLICER_FILE" ]; then
          echo "‚úÖ Found SuperSlicer executable: $SUPERSLICER_FILE"
          cp "$SUPERSLICER_FILE" /opt/render/superslicer/superslicer_console
          FOUND=true
        fi
      fi
      
      if [ "$FOUND" = "true" ]; then
        echo "üîê Setting executable permissions..."
        chmod +x /opt/render/superslicer/superslicer_console
        
        echo "‚úÖ Verifying SuperSlicer installation..."
        ls -la /opt/render/superslicer/superslicer_console
        
        # Test if SuperSlicer can run
        if /opt/render/superslicer/superslicer_console --help >/dev/null 2>&1; then
          echo "‚úÖ SuperSlicer is working correctly"
        else
          echo "‚ö†Ô∏è  SuperSlicer may not work properly, but continuing..."
        fi
      else
        echo "‚ùå SuperSlicer executable not found!"
        echo "üìÅ Contents of extracted directory:"
        ls -la SuperSlicer-2.7.61.1-linux/
        echo "‚ö†Ô∏è  Continuing without SuperSlicer - app will use demo mode"
      fi
      
      echo "üöÄ Build complete!"
      
    startCommand: gunicorn --bind 0.0.0.0:$PORT app:app --workers 2 --timeout 300
    envVars:
      - key: SUPERSLICER_PATH
        value: /opt/render/superslicer/superslicer_console
      - key: COST_PER_HOUR
        value: "3.0"
      - key: DEBUG
        value: "False"
      - key: SECRET_KEY
        value: your-production-secret-key-change-this
      # Optional email configuration
      - key: EMAIL_SENDER
        value: ""
      - key: EMAIL_PASSWORD
        value: ""
      - key: EMAIL_RECIPIENT
        value: ""
      - key: SMTP_SERVER
        value: "smtp.gmail.com"
      - key: SMTP_PORT
        value: "465"
